<!DOCTYPE html>
<html lang='en'>
  <!-- Hello dear source reader, feel free to wander around. -->
  <head>
    <!-- I really think you should use https -->
    <script>
      var host = "www.timfelgentreff.de";
      if ((host == window.location.host) && (window.location.protocol != "https:")) window.location.protocol = "https";
    </script>
    <!-- I *love* UTF-8 -->
    <meta charset='utf-8'>
    <meta content='width=device-width,initial-scale=1.0' name='viewport'>
    <title>CloudFoundry for Smalltalk applications - www.timfelgentreff.de</title>
    <script src='/articles.js?Njc1NDBkOQ==' type='text/javascript'></script>
    <script src='/blog.js?Njc1NDBkOQ==' type='text/javascript'></script>
    <link href='//fonts.googleapis.com/css?family=Fanwood+Text' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <link href='/blog.css?Njc1NDBkOQ==' rel='stylesheet' type='text/css'>
    <link href='https://www.timfelgentreff.de' rel='canonical'>
    <link href='//upload.wikimedia.org/wikipedia/commons/a/a8/Cesium.svg' rel='icon' type='image/jpeg'>
    <link href='http://feeds.feedburner.com/blogbithugorg' rel='alternate' title='https://www.timfelgentreff.de' type='application/rss+xml'>
  </head>
  <body class='hyphenate'>
    <!-- IE 9 supports CSS3/HTML5, or at least that's what I'm told. -->
    <!--[if lt IE 9]>
      <script src='http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js' type='text/javascript'></script>
      <div id='prompt'></div>
      <script>
        window.attachEvent("onload", function() { CFInstall.check({ mode: "inline", node: "prompt" })});
      </script>
    <![endif]-->
    <div class='blog'>
      <div class='header'>
        Coding and stuff
        <!-- .subtitle Because, because, because of the wonderful things he does -->
        <nav>
          <a class='link' href='/cv.html' title='CV'>CV</a>
        </nav>
      </div>
      <nav>
        <a class='link first' href='/2010/06/jax.html' title='Git talk @ JaX 2010'>&lt;&lt;</a>
        <a class='link prev' href='/2011/09/maglev-debug.html' title='Debugging on steroids - what Ru&amp;hellip;'>&lt;</a>
        <a class='link next' href='/2012/05/thesis.html' title='Master Thesis Progress'>&gt;</a>
        <a class='link last' href='/2015/09/phd.html' title='PhD Thesis Progress'>&gt;&gt;</a>
      </nav>
      <article data-source='/2012/02/cloud-foundry-squeak.html'>
        <header>
          <h1 property='dc:title' xmlns:dc='http://purl.org/dc/elements/1.1/'>CloudFoundry for Smalltalk applications</h1>
          <div class='author'>
            by
            <a href='mailto:timfelgentreff@gmail.com' property='cc:attributionName' xmlns:cc='http://creativecommons.org/ns#'>Tim Felgentreff</a>
            ,
            <time class='timeago' datetime='2012-02-22T00:00:00+00:00' pubdate>2012/02/22, 00:00 UTC</time>
          </div>
        </header>
        <section class='content'>
          
          <h2 id="finally">Finally!</h2>
          
          <p>After <a href="http://programminggems.wordpress.com/">James Foster</a> <a href="http://programminggems.wordpress.com/2012/02/17/adding-smalltalk-to-cloud-foundry/">posted</a> about getting <a href="http://www.aidaweb.si/download">Aida</a> running on <a href="http://cloudfoundry.com/">CloudFoundry</a>, I just <em>had</em> to give it a go.</p>
          
          <p>The first step was installing CloudFoundry. I created a <code>vcap</code> user on the server to run the cloud services. Using the <code>dev_setup</code> script from <a href="https://github.com/cloudfoundry/vcap/">https://github.com/cloudfoundry/vcap/</a> got me up and running in just under an hour. The installer will download a few packages (it needs sudo for this) and then install all the runtimes (i.e. language VMs) and frameworks as the local user. Afterwards, the websites hosted here were broken, because there’s another thing that the installer changes, and that is your <code>nginx.conf</code>. By default, it’ll redirect everything to the CloudFoundry router process, which is not what I wanted. I just changed it to only redirect anything under <code>*.vcap.bithug.org</code> to the router, so all other websites could work as previously.</p>
          
          <p>The last thing the installer told you was, how to run the cloud: ~/cloudfoundry/vcap/dev_setup/bin/vcap_dev start I found that, since we have a global RVM setup on this server, this interfered with the local rvm install the cloud foundry script set up, so I changed the .bashrc of this user to not load RVM and only use this minimal <code>PATH</code></p>
          
          <p><a href="//gist.github.com/1886224">bashrc</a></p>
          
          <p>After starting, I tested the setup with this simple Sinatra app:</p>
          
          <p><a href="//gist.github.com/1886224">env.rb</a></p>
          
          <p>To do this, I needed to create a user on the server, using the vmc script. vmc adduser Afterwards, it might be a good idea to change <code>~/cloudfoundry/.deployments/dev_box/config/cloud_controller.yml</code>, insert your own email address into the list of admin users and disallow registering users through vmc. This way, only you’ll be able to add new users.</p>
          
          <p>With this out of the way, we can just put the Sinatra app in an empty directory and run vmc push It will ask a series of questions, I accepted the defaults after choosing <em>env</em> as the name for my app. I verified that it worked by going to <a href="http://env.vcap.bithug.org">http://env.vcap.bithug.org</a>.</p>
          
          <h4 id="smalltalk_the_server_side">Smalltalk, the Server Side</h4>
          
          <p>Now, the good stuff :) For getting Smalltalk to run, I pretty much followed James’ <a href="http://programminggems.wordpress.com/2012/02/17/adding-smalltalk-to-cloud-foundry/">instructions</a>. But I wasn’t interested in Aida. For my master’s thesis, I will need a few small apps running under different URLs. For one of those apps, I’ll be using Smalltalk apps written in a tiny web library called <a href="http://ss3.gemstone.com/ss/RatPack.html">RatPack</a> (yes, it’s a Sinatra look-alike in Smalltalk - even the error page is copied). So I needed a way to run arbitrary Smalltalk apps.</p>
          
          <p>To do this, I changed James’ instructions to define a <code>Squeak</code>, rather than a <code>Aida</code> framework. While I was at it, I also changed a few other things:</p>
          
          <ul>
          <li>I use the latest CogVM builds from <a href="http://www.mirandabanda.org/">Eliot Miranda</a>‘s website.</li>
          
          <li>I install a patch during staging that will mirror the Transcript to a logfile, so you can have ‘some’ debugging</li>
          
          <li>I installed the smalltalk services stuff in the <code>vcap</code> user’s home directory</li>
          </ul>
          
          <p>You can grab the complete patch <a href="https://github.com/timfel/vcap/commit/dcd2469d0738af05315495a413db736f8aa97b76">here</a>.</p>
          
          <p>Because CloudFoundry assigns a random port to its apps, I used James’ solution of passing the <code>$VCAP_APP_PORT</code> as a commandline argument for the Squeak application to use. However, because I don’t know what the app is going to look like, the developer will have to make sure that his/her app honors that argument.</p>
          
          <h4 id="smalltalk_the_smalltalk_side">Smalltalk, the Smalltalk Side</h4>
          
          <p>Now I created a (very simple) RatPack application:</p>
          
          <p><a href="//gist.github.com/1886415">app.st</a></p>
          
          <p>Usually, with RatPack, you will use the Morphic control panel to start applications, assign them a port and so on. On CloudFoundry, the cloud controller might start an image on any port it chooses, or run multiple instances in parallel. To make sure our application is always running on the right port, I added these methods to the <em>class side</em> of the <code>TestApp</code> class:</p>
          
          <p><a href="//gist.github.com/1886415">classside.st</a></p>
          
          <p>This will make sure the application is properly shutdown and restarted whenever an image is stopped and re-run.</p>
          
          <p>Now, to push this to the cloud, we need a <code>squeak.st</code> script that creates our initial image. To make this step fast and easy, I created a small <a href="http://ss3.gemstone.com/ss/CloudFoundry.html">project</a> to create <code>pushable</code> directories and scripts from your applications. Install it and run:</p>
          
          <p><a href="//gist.github.com/1886415">script.st</a></p>
          
          <p>It asks whether you want to install any <em>MetacelloConfigurations</em> and/or <em>MCZs</em>. I chose <code>ConfigurationOfRatPack</code> in version 1.0 with the default group, as well as my TestApp MCZ. The script creates a folder named <code>vmc</code> in your default Smalltalk directory with two MCZs copied from your <code>package-cache</code>, as well as a <code>squeak.st</code> script to run during the staging process:</p>
          
          <p><a href="//gist.github.com/1886415">squeak.st</a></p>
          
          <p>As you can see, this script will install the configuration and the mcz, as well as the RFB server, so you can connect to your image via VNC for debugging.</p>
          
          <p>To actually push this application, again follow James’ <a href="http://programminggems.wordpress.com/2012/02/14/preparing-smalltalk-for-cloud-foundry/">instructions</a> to patch the vmc gem on your development machine (second to last paragraph, adjust it so it reads <code>squeak</code> instead of <code>aida</code> in all places).</p>
          
          <p>With that done, it’s as easy as going into the <code>vmc</code> directory and running <code>vmc push</code>. It should recognize that you’re working with a Squeak application and ask for deployment details.</p>
          
          <p>In my case, because Squeak actually has to load quite a few things during staging, the client then timed out and reported a failure. You can check the transcript logfile or with VNC to make sure everything works as expected. Once you got it working, use</p>
          
          <p><a href="//gist.github.com/1886415">deploy.st</a></p>
          
          <p>to generate a deployment without VNC access to lock down your image.</p>
          
          <p>Go say thanks to <a href="http://programminggems.wordpress.com/">James</a> and <a href="http://maglevity.wordpress.com/about/">Peter</a> for doing the hard work and finding all that out!</p>
        </section>
        <br>
        <section class='license'>
          <a rel="cc:attributionURL" href="http://github.com/rkh/rkh.im">This work</a> is licensed under a
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/de/deed.en">Creative Commons
          Attribution-ShareAlike 3.0 Germany License</a>. Any source code included is, unless stated otherwise,
          licensed under a <a rel="licenses" href="http://creativecommons.org/licenses/MIT/">MIT License</a>.
          <span class='noprint'>This does not apply for comments (below).</span>
        </section>
        <section class='comments'>
          <!-- I both love and hate disqus -->
        </section>
      </article>
      <aside>
        <p>
          <a href='//feeds.feedburner.com/blogbithugorg' rel='alternate' title='Subscribe to my feed' type='application/rss+xml'>
            <img alt='Subscribe to my feed' src='/public/images/feed-icon.png' width='32px'>
          </a>
        </p>
        <a href='/cv.html' title='CV'>
          <img src='//www.gravatar.com/avatar/36fee2e65c9c0ed678fe3b7d862ed271?s=180'>
        </a>
        
        <p>I received a doctoral degree at the <a href="http://www.hpi.de/swa">Software Architecture Group</a> of the <a href="http://www.hpi.de/">Hasso Plattner Institute</a> at the <a href="http://www.uni-potsdam.de/">University Of Potsdam</a>.</p>
        
        <p>I am now working on programming language and VM related things at Oracle Labs.</p>
        
        <p>You can follow me on <a href="http://twitter.com/timfelgentreff">Twitter</a>. Most of the code I’m talking about is on <a href="http://github.com/timfel">GitHub</a>. I also have a <a href="/cv.html">CV</a>, although I am lazy about updating it.</p>
        <h3>Posts</h3>
        <article>
          <div class='date'>2015/09/25</div>
          <a href='/2015/09/phd.html'>PhD Thesis Progress</a>
        </article>
        <article>
          <div class='date'>2015/04/10</div>
          <a href='/2015/04/rsqueak.html'>RSqueak/VM - A research VM for Squeak/Smalltalk</a>
        </article>
        <article>
          <div class='date'>2012/08/27</div>
          <a href='/2012/08/qoppa.html'>Qoppa - a language to learn about Fexpr's</a>
        </article>
        <article>
          <div class='date'>2012/05/31</div>
          <a href='/2012/05/thesis.html'>Master Thesis Progress</a>
        </article>
        <article>
          <div class='date'>2012/02/22</div>
          <a href='/2012/02/cloud-foundry-squeak.html'>CloudFoundry for Smalltalk applications</a>
        </article>
        <article>
          <div class='date'>2011/09/08</div>
          <a href='/2011/09/maglev-debug.html'>Debugging on steroids - what Ruby should learn from Smalltalk</a>
        </article>
        <article>
          <div class='date'>2010/11/28</div>
          <a href='/2010/11/powersaving-on-macbook.html'>Linux PM on Macbook Pro</a>
        </article>
        <article>
          <div class='date'>2010/11/10</div>
          <a href='/2010/11/rsoc.html'>Ruby Summer of Code Wrap-Up</a>
        </article>
        <article>
          <div class='date'>2010/10/23</div>
          <a href='/2010/10/redcar-syntax-checks.html'>Syntax Checking For Redcar</a>
        </article>
        <article>
          <div class='date'>2010/09/26</div>
          <a href='/2010/09/redcar-debug.html'>A Redcar debugger interface</a>
        </article>
        <article>
          <div class='date'>2010/08/14</div>
          <a href='/2010/08/benchmarking-rdiscount.html'>Benchmarking RDiscount</a>
        </article>
        <article>
          <div class='date'>2010/07/13</div>
          <a href='/2010/07/thin-on-jruby.html'>Thin on JRuby</a>
        </article>
        <article>
          <div class='date'>2010/07/09</div>
          <a href='/2010/07/capi-the-thin-gem-and-not-much-to-show.html'>JRuby commit flag</a>
        </article>
        <article>
          <div class='date'>2010/06/18</div>
          <a href='/2010/06/first-week-of-rubysoc.html'>First week of RubySOC</a>
        </article>
        <article>
          <div class='date'>2010/06/07</div>
          <a href='/2010/06/jax.html'>Git talk @ JaX 2010</a>
        </article>
      </aside>
    </div>
  </body>
</html>
